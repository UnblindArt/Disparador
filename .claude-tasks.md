# ğŸ¯ WhatsApp Dispatcher - Plano de ImplementaÃ§Ã£o Completo

## ğŸ“‹ Resumo dos Problemas Atuais

### Erros Identificados:
1. âŒ **POST /api/messages/send â†’ 500**: Backend nÃ£o implementado corretamente
2. âŒ **POST /api/campaigns â†’ 500**: "No valid contacts found for this campaign"
3. âŒ **GET /api/whatsapp/instances/teste-claude/qrcode â†’ 404**: Nome com espaÃ§o nÃ£o encodado

### Funcionalidades Faltantes:
1. âŒ SincronizaÃ§Ã£o de contatos do WhatsApp conectado
2. âŒ Busca de contatos por nome/nÃºmero
3. âŒ SeleÃ§Ã£o mÃºltipla de contatos
4. âŒ Delay randomizado entre 3-10s no envio
5. âŒ Upload de arquivos CSV/XLS/XLSX/PDF para campanhas
6. âŒ Parser de contatos dos arquivos
7. âŒ Interface de chat estilo messenger
8. âŒ SincronizaÃ§Ã£o de mensagens do WhatsApp

---

## ğŸ—ï¸ ARQUITETURA COMPLETA

### 1. ğŸ“± MÃ“DULO: MENSAGENS (Messages)

#### Frontend (`/frontend/src/pages/Messages.tsx`)
```typescript
interface Message {
  to: string[]          // MÃºltiplos destinatÃ¡rios
  message: string
  mediaUrl?: string
  instanceName: string
  delay: {
    min: number        // 3 segundos
    max: number        // 10 segundos
  }
}

Components:
- ContactSearchBar: Busca com autocomplete
- ContactMultiSelect: SeleÃ§Ã£o mÃºltipla com chips
- MessageComposer: Editor de mensagem + mÃ­dia
- SendProgress: Barra de progresso com status
```

#### Backend (`/backend/src/`)

**Routes** (`routes/messages.js`):
```javascript
POST   /api/messages/send                    // Enviar para mÃºltiplos
GET    /api/messages                         // Listar histÃ³rico
GET    /api/messages/stats                   // EstatÃ­sticas
```

**Controller** (`controllers/messageController.js`):
```javascript
sendMessage() {
  1. Validar contatos
  2. Validar instÃ¢ncia conectada
  3. Criar job na fila (Bull Queue)
  4. Retornar ID do job
}
```

**Service** (`services/messageService.js`):
```javascript
processMessageQueue() {
  for each contact {
    1. Calcular delay random (3-10s)
    2. Aguardar delay
    3. Enviar via Evolution API
    4. Registrar no banco
    5. Atualizar status
  }
}
```

**Evolution API Integration**:
```javascript
POST https://evo.unblind.cloud/message/sendText/{instance}
Body: {
  "number": "5547999999999",
  "text": "Mensagem aqui"
}
```

---

### 2. ğŸ“Š MÃ“DULO: CAMPANHAS (Campaigns)

#### Frontend (`/frontend/src/pages/Campaigns.tsx`)
```typescript
interface Campaign {
  name: string
  message: string
  mediaUrl?: string
  contacts: string[]      // IDs ou nÃºmeros
  contactFile?: File      // Upload CSV/XLS/PDF
  instanceName: string
  schedule?: Date
  delay: {
    min: number
    max: number
  }
}

Components:
- CampaignForm: FormulÃ¡rio completo
- FileUploader: Drag & drop multi-formato
- ContactPreview: Preview dos contatos extraÃ­dos
- CampaignProgress: Status em tempo real
```

#### Backend (`/backend/src/`)

**Routes** (`routes/campaigns.js`):
```javascript
POST   /api/campaigns                        // Criar campanha
POST   /api/campaigns/upload                 // Upload + parse
GET    /api/campaigns                        // Listar
GET    /api/campaigns/:id                    // Detalhes
POST   /api/campaigns/:id/pause              // Pausar
POST   /api/campaigns/:id/resume             // Retomar
POST   /api/campaigns/:id/cancel             // Cancelar
```

**Controller** (`controllers/campaignController.js`):
```javascript
createCampaign() {
  1. Validar dados
  2. Se tem arquivo, fazer parse
  3. Validar contatos
  4. Criar campanha no banco
  5. Criar jobs na fila
}

uploadAndParse() {
  1. Receber arquivo (multer)
  2. Identificar tipo (CSV/XLS/XLSX/PDF)
  3. Chamar parser apropriado
  4. Retornar lista de contatos
}
```

**Service** (`services/campaignService.js`):
```javascript
parseCSV(file) {
  // Usar 'csv-parser'
  // Detectar colunas: phone, name, etc
}

parseExcel(file) {
  // Usar 'xlsx'
  // Suportar mÃºltiplas abas
}

parsePDF(file) {
  // Usar 'pdf-parse'
  // Extrair nÃºmeros via regex
}

processCampaignQueue() {
  1. Para cada contato
  2. Delay randomizado 3-10s
  3. Enviar via Evolution
  4. Atualizar progresso
  5. Tratar erros
}
```

**Dependencies necessÃ¡rias**:
```bash
npm install csv-parser xlsx pdf-parse multer
```

---

### 3. ğŸ’¬ MÃ“DULO: CHAT (Conversations)

#### Frontend (`/frontend/src/pages/Chat.tsx`)
```typescript
Layout:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Header (instÃ¢ncia atual)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          â”‚                          â”‚
â”‚  Chat    â”‚   Conversa Aberta       â”‚
â”‚  List    â”‚                          â”‚
â”‚  (1/3)   â”‚   Messages               â”‚
â”‚          â”‚   (2/3)                  â”‚
â”‚          â”‚                          â”‚
â”‚          â”‚                          â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          â”‚ Input + Send Button     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Components:
- ChatList: Lista de conversas (lado esquerdo)
  - Avatar + Nome/NÃºmero
  - Ãšltima mensagem
  - Timestamp
  - Unread badge

- ChatWindow: Conversa aberta (lado direito)
  - Header com info do contato
  - MessageList com scroll infinito
  - MessageInput com emoji picker
  - BotÃ£o anexar mÃ­dia

- Message: BalÃ£o de mensagem
  - Texto/MÃ­dia
  - Status (sent/delivered/read)
  - Timestamp
```

#### Backend (`/backend/src/`)

**Routes** (`routes/conversations.js`):
```javascript
GET    /api/conversations                    // Listar chats
GET    /api/conversations/:id                // Mensagens de um chat
POST   /api/conversations/:id/messages       // Enviar mensagem
PUT    /api/conversations/:id/read           // Marcar como lido
```

**Controller** (`controllers/conversationController.js`):
```javascript
getConversations() {
  1. Buscar do banco local
  2. Se vazio, sincronizar da Evolution
  3. Ordenar por Ãºltima mensagem
}

getMessages(chatId) {
  1. Buscar mensagens do banco
  2. Marcar como lidas
  3. Retornar paginado
}

sendMessage(chatId, text) {
  1. Enviar via Evolution
  2. Salvar no banco
  3. Emitir evento Socket.IO
}
```

**Service** (`services/conversationService.js`):
```javascript
syncChatsFromWhatsApp(instanceName) {
  // GET /chat/findChats/{instance}
  // Salvar no banco
}

syncMessagesFromChat(instanceName, chatId) {
  // GET /chat/findMessages/{instance}
  // Salvar no banco
}
```

**Evolution API Integration**:
```javascript
// Buscar chats
GET https://evo.unblind.cloud/chat/findChats/{instance}

// Buscar mensagens
GET https://evo.unblind.cloud/chat/findMessages/{instance}
Query: { where: { key: { remoteJid: "phone@s.whatsapp.net" }}}

// Enviar mensagem
POST https://evo.unblind.cloud/message/sendText/{instance}
Body: { "number": "5547999999999", "text": "..." }
```

**Webhook Events** (`controllers/webhookController.js`):
```javascript
// Escutar eventos da Evolution:
- MESSAGES_UPSERT: Nova mensagem recebida
- MESSAGES_UPDATE: Status de mensagem atualizado
- CHATS_UPDATE: Chat atualizado

// Processar e emitir via Socket.IO para frontend
```

---

### 4. ğŸ‘¥ MÃ“DULO: CONTATOS (Contacts)

#### Frontend: JÃ¡ existe, mas melhorar:
```typescript
- Adicionar busca em tempo real
- Adicionar filtros (grupos, individuais)
- Adicionar aÃ§Ãµes em massa
```

#### Backend: Melhorar sincronizaÃ§Ã£o

**Service** (`services/contactService.js`):
```javascript
syncContactsFromWhatsApp(instanceName) {
  // GET /chat/fetchProfilePictureUrl/{instance}
  // GET /chat/findContacts/{instance}

  1. Buscar contatos da Evolution
  2. Comparar com banco local
  3. Atualizar diferenÃ§as
  4. Retornar resumo
}
```

---

## ğŸ“¦ DEPENDÃŠNCIAS NECESSÃRIAS

### Backend:
```bash
cd /opt/whatsapp-dispatcher-client/backend
npm install csv-parser xlsx pdf-parse multer bull socket.io
```

### Frontend:
```bash
cd /opt/whatsapp-dispatcher-client/frontend
npm install @tanstack/react-virtual socket.io-client react-dropzone emoji-picker-react
```

---

## ğŸ”„ FLUXO DE DADOS

### Mensagens (Send):
```
Frontend â†’ Backend â†’ Bull Queue â†’ Worker
  â†“          â†“                      â†“
 UI        Validate              Evolution API
              â†“                      â†“
            Save                  WhatsApp
              â†“                      â†“
          Return Job ID        Webhook callback
              â†“                      â†“
     Polling status         Update DB + Socket.IO
              â†“                      â†“
          Update UI  â†â”€â”€â”€â”€â”€â”€â”€â”€  Frontend receives
```

### Campanhas (Upload):
```
Frontend â†’ Upload â†’ Parse â†’ Preview
  â†“                            â†“
User confirms             Create campaign
  â†“                            â†“
Backend â†’ Queue â†’ Worker â†’ Evolution
  â†“                            â†“
Status updates  â†â”€â”€â”€â”€â”€  Socket.IO
```

### Chat (Real-time):
```
WhatsApp â†’ Evolution Webhook â†’ Backend
              â†“                    â†“
        Process event         Save to DB
              â†“                    â†“
        Socket.IO emit       Frontend receives
              â†“                    â†“
        Update UI         Display message
```

---

## ğŸ¯ PRIORIDADES DE IMPLEMENTAÃ‡ÃƒO

### Fase 1 - CorreÃ§Ãµes CrÃ­ticas (URGENTE):
1. âœ… Corrigir encoding de instanceName (espaÃ§os)
2. â³ Implementar messageController.send() corretamente
3. â³ Corrigir campaignService (validaÃ§Ã£o de contatos)
4. â³ Adicionar delay randomizado 3-10s

### Fase 2 - SincronizaÃ§Ã£o:
5. â³ Sincronizar contatos do WhatsApp
6. â³ Busca de contatos no frontend
7. â³ SeleÃ§Ã£o mÃºltipla de contatos

### Fase 3 - Upload de Arquivos:
8. â³ Implementar upload com multer
9. â³ Parser CSV
10. â³ Parser Excel
11. â³ Parser PDF
12. â³ Preview de contatos

### Fase 4 - Chat (Complexo):
13. â³ Sincronizar conversas
14. â³ Interface de chat (layout 1/3 + 2/3)
15. â³ Socket.IO para real-time
16. â³ Webhook processing

---

## ğŸ“Š DATABASE SCHEMA (Supabase)

```sql
-- Tabela: contacts
CREATE TABLE contacts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id),
  phone VARCHAR(20) NOT NULL,
  name VARCHAR(255),
  avatar_url TEXT,
  is_group BOOLEAN DEFAULT false,
  whatsapp_instance VARCHAR(255),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, phone, whatsapp_instance)
);

-- Tabela: conversations
CREATE TABLE conversations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id),
  contact_id UUID REFERENCES contacts(id),
  whatsapp_instance VARCHAR(255),
  last_message_at TIMESTAMP,
  unread_count INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, contact_id, whatsapp_instance)
);

-- Tabela: messages
CREATE TABLE messages (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  conversation_id UUID REFERENCES conversations(id),
  message_id VARCHAR(255), -- ID da Evolution
  from_me BOOLEAN DEFAULT false,
  phone VARCHAR(20),
  text TEXT,
  media_url TEXT,
  status VARCHAR(50), -- sent, delivered, read, failed
  timestamp TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Tabela: campaigns
CREATE TABLE campaigns (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id),
  name VARCHAR(255) NOT NULL,
  message TEXT NOT NULL,
  media_url TEXT,
  whatsapp_instance VARCHAR(255),
  total_contacts INTEGER,
  sent_count INTEGER DEFAULT 0,
  failed_count INTEGER DEFAULT 0,
  status VARCHAR(50), -- pending, running, paused, completed, failed
  delay_min INTEGER DEFAULT 3,
  delay_max INTEGER DEFAULT 10,
  scheduled_at TIMESTAMP,
  started_at TIMESTAMP,
  completed_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Tabela: campaign_contacts
CREATE TABLE campaign_contacts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  campaign_id UUID REFERENCES campaigns(id) ON DELETE CASCADE,
  contact_id UUID REFERENCES contacts(id),
  status VARCHAR(50), -- pending, sent, failed
  error_message TEXT,
  sent_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

## ğŸš€ COMANDOS DE EXECUÃ‡ÃƒO

### Para iniciar implementaÃ§Ã£o:
```bash
# 1. Instalar dependÃªncias
cd /opt/whatsapp-dispatcher-client/backend && npm install csv-parser xlsx pdf-parse multer bull socket.io
cd /opt/whatsapp-dispatcher-client/frontend && npm install @tanstack/react-virtual socket.io-client react-dropzone emoji-picker-react

# 2. Criar migrations no Supabase (via SQL Editor)

# 3. Atualizar controllers e services

# 4. Testar endpoints individualmente

# 5. Rebuild frontend + backend

# 6. Deploy
```

---

## âœ… CHECKLIST FINAL

- [ ] Mensagens: Envio mÃºltiplo funcionando
- [ ] Mensagens: Delay 3-10s implementado
- [ ] Mensagens: Busca de contatos
- [ ] Mensagens: SeleÃ§Ã£o mÃºltipla
- [ ] Campanhas: Upload CSV funcionando
- [ ] Campanhas: Upload XLS/XLSX funcionando
- [ ] Campanhas: Upload PDF funcionando
- [ ] Campanhas: Preview de contatos
- [ ] Campanhas: Envio com progresso
- [ ] Chat: Layout 1/3 + 2/3
- [ ] Chat: Lista de conversas
- [ ] Chat: Mensagens em tempo real
- [ ] Chat: Envio de mensagens
- [ ] Chat: Webhooks processando
- [ ] Contatos: SincronizaÃ§Ã£o automÃ¡tica
- [ ] Testes: Fluxo completo end-to-end
