# 🎯 WhatsApp Dispatcher - Plano de Implementação Completo

## 📋 Resumo dos Problemas Atuais

### Erros Identificados:
1. ❌ **POST /api/messages/send → 500**: Backend não implementado corretamente
2. ❌ **POST /api/campaigns → 500**: "No valid contacts found for this campaign"
3. ❌ **GET /api/whatsapp/instances/teste-claude/qrcode → 404**: Nome com espaço não encodado

### Funcionalidades Faltantes:
1. ❌ Sincronização de contatos do WhatsApp conectado
2. ❌ Busca de contatos por nome/número
3. ❌ Seleção múltipla de contatos
4. ❌ Delay randomizado entre 3-10s no envio
5. ❌ Upload de arquivos CSV/XLS/XLSX/PDF para campanhas
6. ❌ Parser de contatos dos arquivos
7. ❌ Interface de chat estilo messenger
8. ❌ Sincronização de mensagens do WhatsApp

---

## 🏗️ ARQUITETURA COMPLETA

### 1. 📱 MÓDULO: MENSAGENS (Messages)

#### Frontend (`/frontend/src/pages/Messages.tsx`)
```typescript
interface Message {
  to: string[]          // Múltiplos destinatários
  message: string
  mediaUrl?: string
  instanceName: string
  delay: {
    min: number        // 3 segundos
    max: number        // 10 segundos
  }
}

Components:
- ContactSearchBar: Busca com autocomplete
- ContactMultiSelect: Seleção múltipla com chips
- MessageComposer: Editor de mensagem + mídia
- SendProgress: Barra de progresso com status
```

#### Backend (`/backend/src/`)

**Routes** (`routes/messages.js`):
```javascript
POST   /api/messages/send                    // Enviar para múltiplos
GET    /api/messages                         // Listar histórico
GET    /api/messages/stats                   // Estatísticas
```

**Controller** (`controllers/messageController.js`):
```javascript
sendMessage() {
  1. Validar contatos
  2. Validar instância conectada
  3. Criar job na fila (Bull Queue)
  4. Retornar ID do job
}
```

**Service** (`services/messageService.js`):
```javascript
processMessageQueue() {
  for each contact {
    1. Calcular delay random (3-10s)
    2. Aguardar delay
    3. Enviar via Evolution API
    4. Registrar no banco
    5. Atualizar status
  }
}
```

**Evolution API Integration**:
```javascript
POST https://evo.unblind.cloud/message/sendText/{instance}
Body: {
  "number": "5547999999999",
  "text": "Mensagem aqui"
}
```

---

### 2. 📊 MÓDULO: CAMPANHAS (Campaigns)

#### Frontend (`/frontend/src/pages/Campaigns.tsx`)
```typescript
interface Campaign {
  name: string
  message: string
  mediaUrl?: string
  contacts: string[]      // IDs ou números
  contactFile?: File      // Upload CSV/XLS/PDF
  instanceName: string
  schedule?: Date
  delay: {
    min: number
    max: number
  }
}

Components:
- CampaignForm: Formulário completo
- FileUploader: Drag & drop multi-formato
- ContactPreview: Preview dos contatos extraídos
- CampaignProgress: Status em tempo real
```

#### Backend (`/backend/src/`)

**Routes** (`routes/campaigns.js`):
```javascript
POST   /api/campaigns                        // Criar campanha
POST   /api/campaigns/upload                 // Upload + parse
GET    /api/campaigns                        // Listar
GET    /api/campaigns/:id                    // Detalhes
POST   /api/campaigns/:id/pause              // Pausar
POST   /api/campaigns/:id/resume             // Retomar
POST   /api/campaigns/:id/cancel             // Cancelar
```

**Controller** (`controllers/campaignController.js`):
```javascript
createCampaign() {
  1. Validar dados
  2. Se tem arquivo, fazer parse
  3. Validar contatos
  4. Criar campanha no banco
  5. Criar jobs na fila
}

uploadAndParse() {
  1. Receber arquivo (multer)
  2. Identificar tipo (CSV/XLS/XLSX/PDF)
  3. Chamar parser apropriado
  4. Retornar lista de contatos
}
```

**Service** (`services/campaignService.js`):
```javascript
parseCSV(file) {
  // Usar 'csv-parser'
  // Detectar colunas: phone, name, etc
}

parseExcel(file) {
  // Usar 'xlsx'
  // Suportar múltiplas abas
}

parsePDF(file) {
  // Usar 'pdf-parse'
  // Extrair números via regex
}

processCampaignQueue() {
  1. Para cada contato
  2. Delay randomizado 3-10s
  3. Enviar via Evolution
  4. Atualizar progresso
  5. Tratar erros
}
```

**Dependencies necessárias**:
```bash
npm install csv-parser xlsx pdf-parse multer
```

---

### 3. 💬 MÓDULO: CHAT (Conversations)

#### Frontend (`/frontend/src/pages/Chat.tsx`)
```typescript
Layout:
┌─────────────────────────────────────┐
│ Header (instância atual)            │
├──────────┬──────────────────────────┤
│          │                          │
│  Chat    │   Conversa Aberta       │
│  List    │                          │
│  (1/3)   │   Messages               │
│          │   (2/3)                  │
│          │                          │
│          │                          │
│          ├──────────────────────────┤
│          │ Input + Send Button     │
└──────────┴──────────────────────────┘

Components:
- ChatList: Lista de conversas (lado esquerdo)
  - Avatar + Nome/Número
  - Última mensagem
  - Timestamp
  - Unread badge

- ChatWindow: Conversa aberta (lado direito)
  - Header com info do contato
  - MessageList com scroll infinito
  - MessageInput com emoji picker
  - Botão anexar mídia

- Message: Balão de mensagem
  - Texto/Mídia
  - Status (sent/delivered/read)
  - Timestamp
```

#### Backend (`/backend/src/`)

**Routes** (`routes/conversations.js`):
```javascript
GET    /api/conversations                    // Listar chats
GET    /api/conversations/:id                // Mensagens de um chat
POST   /api/conversations/:id/messages       // Enviar mensagem
PUT    /api/conversations/:id/read           // Marcar como lido
```

**Controller** (`controllers/conversationController.js`):
```javascript
getConversations() {
  1. Buscar do banco local
  2. Se vazio, sincronizar da Evolution
  3. Ordenar por última mensagem
}

getMessages(chatId) {
  1. Buscar mensagens do banco
  2. Marcar como lidas
  3. Retornar paginado
}

sendMessage(chatId, text) {
  1. Enviar via Evolution
  2. Salvar no banco
  3. Emitir evento Socket.IO
}
```

**Service** (`services/conversationService.js`):
```javascript
syncChatsFromWhatsApp(instanceName) {
  // GET /chat/findChats/{instance}
  // Salvar no banco
}

syncMessagesFromChat(instanceName, chatId) {
  // GET /chat/findMessages/{instance}
  // Salvar no banco
}
```

**Evolution API Integration**:
```javascript
// Buscar chats
GET https://evo.unblind.cloud/chat/findChats/{instance}

// Buscar mensagens
GET https://evo.unblind.cloud/chat/findMessages/{instance}
Query: { where: { key: { remoteJid: "phone@s.whatsapp.net" }}}

// Enviar mensagem
POST https://evo.unblind.cloud/message/sendText/{instance}
Body: { "number": "5547999999999", "text": "..." }
```

**Webhook Events** (`controllers/webhookController.js`):
```javascript
// Escutar eventos da Evolution:
- MESSAGES_UPSERT: Nova mensagem recebida
- MESSAGES_UPDATE: Status de mensagem atualizado
- CHATS_UPDATE: Chat atualizado

// Processar e emitir via Socket.IO para frontend
```

---

### 4. 👥 MÓDULO: CONTATOS (Contacts)

#### Frontend: Já existe, mas melhorar:
```typescript
- Adicionar busca em tempo real
- Adicionar filtros (grupos, individuais)
- Adicionar ações em massa
```

#### Backend: Melhorar sincronização

**Service** (`services/contactService.js`):
```javascript
syncContactsFromWhatsApp(instanceName) {
  // GET /chat/fetchProfilePictureUrl/{instance}
  // GET /chat/findContacts/{instance}

  1. Buscar contatos da Evolution
  2. Comparar com banco local
  3. Atualizar diferenças
  4. Retornar resumo
}
```

---

## 📦 DEPENDÊNCIAS NECESSÁRIAS

### Backend:
```bash
cd /opt/whatsapp-dispatcher-client/backend
npm install csv-parser xlsx pdf-parse multer bull socket.io
```

### Frontend:
```bash
cd /opt/whatsapp-dispatcher-client/frontend
npm install @tanstack/react-virtual socket.io-client react-dropzone emoji-picker-react
```

---

## 🔄 FLUXO DE DADOS

### Mensagens (Send):
```
Frontend → Backend → Bull Queue → Worker
  ↓          ↓                      ↓
 UI        Validate              Evolution API
              ↓                      ↓
            Save                  WhatsApp
              ↓                      ↓
          Return Job ID        Webhook callback
              ↓                      ↓
     Polling status         Update DB + Socket.IO
              ↓                      ↓
          Update UI  ←────────  Frontend receives
```

### Campanhas (Upload):
```
Frontend → Upload → Parse → Preview
  ↓                            ↓
User confirms             Create campaign
  ↓                            ↓
Backend → Queue → Worker → Evolution
  ↓                            ↓
Status updates  ←─────  Socket.IO
```

### Chat (Real-time):
```
WhatsApp → Evolution Webhook → Backend
              ↓                    ↓
        Process event         Save to DB
              ↓                    ↓
        Socket.IO emit       Frontend receives
              ↓                    ↓
        Update UI         Display message
```

---

## 🎯 PRIORIDADES DE IMPLEMENTAÇÃO

### Fase 1 - Correções Críticas (URGENTE):
1. ✅ Corrigir encoding de instanceName (espaços)
2. ⏳ Implementar messageController.send() corretamente
3. ⏳ Corrigir campaignService (validação de contatos)
4. ⏳ Adicionar delay randomizado 3-10s

### Fase 2 - Sincronização:
5. ⏳ Sincronizar contatos do WhatsApp
6. ⏳ Busca de contatos no frontend
7. ⏳ Seleção múltipla de contatos

### Fase 3 - Upload de Arquivos:
8. ⏳ Implementar upload com multer
9. ⏳ Parser CSV
10. ⏳ Parser Excel
11. ⏳ Parser PDF
12. ⏳ Preview de contatos

### Fase 4 - Chat (Complexo):
13. ⏳ Sincronizar conversas
14. ⏳ Interface de chat (layout 1/3 + 2/3)
15. ⏳ Socket.IO para real-time
16. ⏳ Webhook processing

---

## 📊 DATABASE SCHEMA (Supabase)

```sql
-- Tabela: contacts
CREATE TABLE contacts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id),
  phone VARCHAR(20) NOT NULL,
  name VARCHAR(255),
  avatar_url TEXT,
  is_group BOOLEAN DEFAULT false,
  whatsapp_instance VARCHAR(255),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, phone, whatsapp_instance)
);

-- Tabela: conversations
CREATE TABLE conversations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id),
  contact_id UUID REFERENCES contacts(id),
  whatsapp_instance VARCHAR(255),
  last_message_at TIMESTAMP,
  unread_count INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, contact_id, whatsapp_instance)
);

-- Tabela: messages
CREATE TABLE messages (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  conversation_id UUID REFERENCES conversations(id),
  message_id VARCHAR(255), -- ID da Evolution
  from_me BOOLEAN DEFAULT false,
  phone VARCHAR(20),
  text TEXT,
  media_url TEXT,
  status VARCHAR(50), -- sent, delivered, read, failed
  timestamp TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Tabela: campaigns
CREATE TABLE campaigns (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id),
  name VARCHAR(255) NOT NULL,
  message TEXT NOT NULL,
  media_url TEXT,
  whatsapp_instance VARCHAR(255),
  total_contacts INTEGER,
  sent_count INTEGER DEFAULT 0,
  failed_count INTEGER DEFAULT 0,
  status VARCHAR(50), -- pending, running, paused, completed, failed
  delay_min INTEGER DEFAULT 3,
  delay_max INTEGER DEFAULT 10,
  scheduled_at TIMESTAMP,
  started_at TIMESTAMP,
  completed_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Tabela: campaign_contacts
CREATE TABLE campaign_contacts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  campaign_id UUID REFERENCES campaigns(id) ON DELETE CASCADE,
  contact_id UUID REFERENCES contacts(id),
  status VARCHAR(50), -- pending, sent, failed
  error_message TEXT,
  sent_at TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

## 🚀 COMANDOS DE EXECUÇÃO

### Para iniciar implementação:
```bash
# 1. Instalar dependências
cd /opt/whatsapp-dispatcher-client/backend && npm install csv-parser xlsx pdf-parse multer bull socket.io
cd /opt/whatsapp-dispatcher-client/frontend && npm install @tanstack/react-virtual socket.io-client react-dropzone emoji-picker-react

# 2. Criar migrations no Supabase (via SQL Editor)

# 3. Atualizar controllers e services

# 4. Testar endpoints individualmente

# 5. Rebuild frontend + backend

# 6. Deploy
```

---

## ✅ CHECKLIST FINAL

- [ ] Mensagens: Envio múltiplo funcionando
- [ ] Mensagens: Delay 3-10s implementado
- [ ] Mensagens: Busca de contatos
- [ ] Mensagens: Seleção múltipla
- [ ] Campanhas: Upload CSV funcionando
- [ ] Campanhas: Upload XLS/XLSX funcionando
- [ ] Campanhas: Upload PDF funcionando
- [ ] Campanhas: Preview de contatos
- [ ] Campanhas: Envio com progresso
- [ ] Chat: Layout 1/3 + 2/3
- [ ] Chat: Lista de conversas
- [ ] Chat: Mensagens em tempo real
- [ ] Chat: Envio de mensagens
- [ ] Chat: Webhooks processando
- [ ] Contatos: Sincronização automática
- [ ] Testes: Fluxo completo end-to-end
